# Migrate Code Dx Data to Docker Compose

Here are the steps to migrate your Code Dx data from a system created by the Code Dx Installer to your Docker Compose Code Dx instance. The Code Dx version you are running with Docker Compose must be equal to or greater than your source Code Dx system (with the data you want to migrate). If necessary, upgrade your Code Dx version before migrating your Code Dx data.

1. Log on to the system running Code Dx with Docker Compose, change directory to this repository (codedx-docker folder), and verify that Code Dx is running.

   1. Install [PowerShell Core v7](https://docs.microsoft.com/en-us/powershell/scripting/install/installing-powershell?view=powershell-7), if necessary (run `pwsh -version` to see installed version).

      >Note: On Windows, make sure that you can run PowerShell Core scripts by switching your [PowerShell Execution Policy](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies) to RemoteSigned (recommended) or Unrestricted. You must run the `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned` command from an elevated/administrator Command Prompt.

2. Log on to your source Code Dx server.

   1. Run mysqldump to create a backup file. You can run the following command to create a dump-codedx.sql file after specifying the parameters that work for your database.

      ```
      mysqldump --host=127.0.0.1 --port=3306 --user=root -p codedx > dump-codedx.sql
      ```

      >Note: The above command uses a database named codedx. Older versions of Code Dx may use a database named bitnami_codedx.

   2. Locate the directory path for your Code Dx AppData directory (e.g., /path/to/codedx_data/codedx_appdata). The AppData directory contains your analysis-files and log-files directories.

   3. Copy your database dump file and Code Dx AppData directory to the system running Code Dx with Docker Compose.

3. Return to the system running Code Dx with Docker Compose, change directory to this repository (codedx-docker folder), and run the migrate-data.ps1 script with the following commands. When prompted, enter the path to your dump-codedx.sql file, your Code Dx AppData directory, and specify the password for the root database user.

   ```
   cd codedx-docker
   pwsh ./admin/migrate-data.ps1
   ```

   >Note: The above command will use the default values for the script parameters `-tomcatContainerName` (codedx-docker_codedx-tomcat_1), `-dbContainerName` (codedx-docker_codedx-db_1), and `dbName` (codedx). You can find your Docker container names by running `docker ps`.

   Your script output should look similar to this:
 
   ```
   $ pwsh ./admin/migrate-data.ps1
   Enter the path to your mysqldump file: /path/to/dump-codedx.sql
   VERBOSE: Checking database dump file path...
   Enter the path to your Code Dx AppData folder: /path/to/codedx
   VERBOSE: Checking appdata path...
   VERBOSE: Checking appdata/analysis-files path...
   Enter a password for the MariaDB root user: **********
   VERBOSE: Checking PATH prerequisites...
   VERBOSE: Checking running containers...
   VERBOSE: Dropping database named codedx...
   VERBOSE: Creating database named codedx...
   VERBOSE: Creating temporary directory...
   VERBOSE: Copying database dump file to container...
   VERBOSE: Importing database dump file (may take a while)...
   VERBOSE: Deleting database dump file...
   VERBOSE: Deleting directories...
   VERBOSE: Deleting directory /opt/codedx/analysis-files...
   VERBOSE: Deleting directory /opt/codedx/keystore...
   VERBOSE: Deleting directory /opt/codedx/mltriage-files...
   VERBOSE: Copying directories...
   VERBOSE: Copying directory /path/to/codedx/analysis-files to /opt/codedx/analysis-files...
   VERBOSE: Copying directory /path/to/codedx/mltriage-files to /opt/codedx/mltriage-files...
   VERBOSE: Restarting Code Dx...
   Restarting codedx-docker_codedx-tomcat_1 ... done
   Restarting codedx-docker_codedx-db_1     ... done
   Done
   ```
